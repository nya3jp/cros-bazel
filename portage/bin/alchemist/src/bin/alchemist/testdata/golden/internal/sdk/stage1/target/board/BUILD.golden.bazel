# AUTO-GENERATED FILE. DO NOT EDIT.

# Copyright 2023 The ChromiumOS Authors
# Use of this source code is governed by a BSD-style license that can be
# found in the LICENSE file.

load("@//bazel/portage/build_defs:overlay.bzl", "overlay_set")
load("@//bazel/portage/build_defs:package_set.bzl", "package_set")
load("@//bazel/portage/build_defs:sdk.bzl", "sdk_extend", "sdk_install_glibc", "sdk_install_deps")
load("@rules_pkg//pkg:tar.bzl", "pkg_tar")
load("@rules_pkg//pkg:mappings.bzl", "pkg_attributes", "pkg_filegroup", "pkg_files", "pkg_mkdirs", "pkg_mklink", "strip_prefix")

pkg_files(
    name = "make_conf_board",
    srcs = [
        "make.conf.board",
        "make.conf.board_setup",
    ],
    strip_prefix = strip_prefix.from_pkg(),
)

pkg_mklink(
    name = "make_conf",
    link_name = "make.conf",
    target = "/mnt/host/source/src/third_party/chromiumos-overlay/chromeos/config/make.conf.generic-target",
)

pkg_mklink(
    name = "make_conf_user",
    link_name = "make.conf.user",
    target = "/etc/make.conf.user",
)

pkg_mklink(
    name = "portage_hooks",
    link_name = "portage/hooks",
    target = "/mnt/host/source/src/scripts/hooks",
)

pkg_mklink(
    name = "portage_make_profile",
    link_name = "portage/make.profile",
    target = "/mnt/host/source/src/overlays/overlay-amd64-generic/profiles/base",
)

pkg_filegroup(
    name = "etc",
    prefix = "build/amd64-generic/etc",
    srcs = [
        ":make_conf",
        ":make_conf_board",
        ":make_conf_user",
        ":portage_hooks",
        ":portage_make_profile",
    ],
)

# Create /usr/share/aclocal to make autoconf work.
# TODO: Figure out why this is needed.
pkg_mkdirs(
    name = "aclocal",
    dirs = ["build/amd64-generic/usr/share/aclocal"],
)

pkg_files(
    name = "wrappers_build_bin",
    srcs = [
        "pkg-config",
        "emerge",
        "ebuild",
        "eclean",
        "emaint",
        "equery",
        "portageq",
        "qcheck",
        "qdepends",
        "qfile",
        "qlist",
        "qmerge",
        "qsize",
    ],
    strip_prefix = strip_prefix.from_pkg(),
    prefix = "build/amd64-generic/build/bin",
    attributes = pkg_attributes(
        mode = "0755",
    ),
)

pkg_files(
    name = "wrappers_usr_local_bin",
    srcs = [
        "pkg-config",
        "emerge",
        "ebuild",
        "eclean",
        "emaint",
        "equery",
        "portageq",
        "qcheck",
        "qdepends",
        "qfile",
        "qlist",
        "qmerge",
        "qsize",
    ],
    renames = {
        "pkg-config": "pkg-config-amd64-generic",
        "emerge": "emerge-amd64-generic",
        "ebuild": "ebuild-amd64-generic",
        "eclean": "eclean-amd64-generic",
        "emaint": "emaint-amd64-generic",
        "equery": "equery-amd64-generic",
        "portageq": "portageq-amd64-generic",
        "qcheck": "qcheck-amd64-generic",
        "qdepends": "qdepends-amd64-generic",
        "qfile": "qfile-amd64-generic",
        "qlist": "qlist-amd64-generic",
        "qmerge": "qmerge-amd64-generic",
        "qsize": "qsize-amd64-generic",
    },
    strip_prefix = strip_prefix.from_pkg(),
    prefix = "usr/local/bin",
    attributes = pkg_attributes(
        mode = "0755",
    ),
)

pkg_tar(
    name = "board_extra_tarball",
    srcs = [
        ":aclocal",
        ":etc",
        ":wrappers_build_bin",
        ":wrappers_usr_local_bin",
    ],
    extension = "tar",
    visibility = ["@//bazel:internal"],
)

# Needed for the build_image targets
alias(
    name = "overlays",
    actual = "//internal/overlays:amd64-generic-full",
    visibility = ["@//bazel:internal"],
)
package_set(
    name = "cross-packages",
    deps = [
        "@//bazel/portage/repo_defs/prebuilts/amd64-host/cross-x86_64-cros-linux-gnu:binutils",
        "@//bazel/portage/repo_defs/prebuilts/amd64-host/cross-x86_64-cros-linux-gnu:gcc",
        "@//bazel/portage/repo_defs/prebuilts/amd64-host/cross-x86_64-cros-linux-gnu:gdb",
        "@//bazel/portage/repo_defs/prebuilts/amd64-host/cross-x86_64-cros-linux-gnu:glibc",
        "@//bazel/portage/repo_defs/prebuilts/amd64-host/cross-x86_64-cros-linux-gnu:go",
        "@//bazel/portage/repo_defs/prebuilts/amd64-host/cross-x86_64-cros-linux-gnu:libcxx",
        "@//bazel/portage/repo_defs/prebuilts/amd64-host/cross-x86_64-cros-linux-gnu:libxcrypt",
        "@//bazel/portage/repo_defs/prebuilts/amd64-host/cross-x86_64-cros-linux-gnu:linux-headers",
        "@//bazel/portage/repo_defs/prebuilts/amd64-host/cross-x86_64-cros-linux-gnu:llvm-libunwind",
    ],
    visibility = ["@//bazel:internal"],
)

sdk_install_deps(
    name = "additional-host-tools",
    base = "@//bazel/portage/sdk:stage1",
    overlays = "//internal/overlays:amd64-generic",
    target_deps = [
        ":cross-packages",
        "@//bazel/portage/repo_defs/prebuilts/amd64-host/dev-embedded:coreboot-sdk",
        "@//bazel/portage/repo_defs/prebuilts/amd64-host/dev-embedded:hps-sdk",
        "@//bazel/portage/repo_defs/prebuilts/amd64-host/dev-lang:rust",
        "@//bazel/portage/repo_defs/prebuilts/amd64-host/dev-util:glib-utils",
    ],
    install_strategy = select({
        "//:binpkg-cache-fast": "fast",
        "//:binpkg-cache-naive": "naive",
        "//conditions:default": "slow",
    }),
    progress_message = "Installing {dep_count} host packages into %{label}",
    visibility = ["@//bazel:internal"],
)

# The legacy setup_bord flow relied on manually copying glibc into the board's
# SYSROOT instead of compiling glibc for the host. In order to not deviate
# we need to do the same thing.
# TODO(b/266979761): Make legacy flow compile glibc as a normal package.
sdk_install_glibc(
    name = "glibc",
    base = ":additional-host-tools",
    board = "amd64-generic",
    glibc = "@//bazel/portage/repo_defs/prebuilts/amd64-host/cross-x86_64-cros-linux-gnu:glibc",
)

sdk_extend(
    name = "base",
    base = ":glibc",
    extra_tarballs = [
        ":board_extra_tarball",
    ],
    visibility = ["@//bazel:internal"],
)

sdk_install_deps(
    name = "board",
    base = ":base",
    board = "amd64-generic",
    overlays = "//internal/overlays:amd64-generic",
    target_deps = [
        "//internal/packages/stage1/target/board/chromiumos/sys-kernel/linux-headers:4.14",
        "//internal/packages/stage1/target/board/chromiumos/sys-libs/gcc-libs:10.2.0",
        "//internal/packages/stage1/target/board/chromiumos/sys-libs/libcxx:16.0_pre484197",
        "//internal/packages/stage1/target/board/chromiumos/sys-libs/llvm-libunwind:16.0_pre484197",
        "//internal/packages/stage1/target/board/portage-stable/virtual/os-headers:0-r2",
    ],
    install_strategy = select({
        "//:binpkg-cache-fast": "fast",
        "//:binpkg-cache-naive": "naive",
        "//conditions:default": "slow",
    }),
    progress_message = "Installing {dep_count} stage 1 primordial packages for amd64-generic",
    visibility = ["@//bazel:internal"],
)
