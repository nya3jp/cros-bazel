load("@rules_foreign_cc//foreign_cc:defs.bzl", "configure_make")

package(default_visibility = ["//visibility:public"])

# By default it outputs to fuse.build_tmpdir/util, but it needs to output to
# fuse.build_tmpdir/fuse.
# This is a bit of a hack to get around the fact that configure_make doesn't
# support pointing env at the output path.
_FUSE_OUT_PREFIX = "../fuse"

configure_make(
    name = "fuse",
    autogen = True,
    autogen_command = "makeconf.sh",
    configure_in_place = True,
    env = {
        "MOUNT_FUSE_PATH": "%s/sbin" % _FUSE_OUT_PREFIX,
        "UDEV_RULES_PATH": "%s/etc/udev/rules.d" % _FUSE_OUT_PREFIX,
        "INIT_D_PATH": "%s/etc/init.d" % _FUSE_OUT_PREFIX,
    },
    lib_source = "@fuse//:all_srcs",
    out_bin_dir = "",
    out_binaries = [
        "bin/ulockmgr_server",
        "bin/fusermount",
        "sbin/mount.fuse",
    ],
    out_data_dirs = [
        "etc",
    ],
)
