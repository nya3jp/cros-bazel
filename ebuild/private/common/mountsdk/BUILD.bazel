# Copyright 2022 The ChromiumOS Authors.
# Use of this source code is governed by a BSD-style license that can be
# found in the LICENSE file.

load("@io_bazel_rules_go//go:def.bzl", "go_library", "go_test")
load("@bazel_skylib//rules:common_settings.bzl", "bool_flag", "string_flag")

go_library(
    name = "mountsdk",
    srcs = [
        "cli.go",
        "mountsdk.go",
    ],
    data = [
        "//bazel/ebuild/private/cmd/run_in_container",
    ],
    embedsrcs = ["setup.sh"],
    importpath = "cros.local/bazel/ebuild/private/common/mountsdk",
    visibility = ["//visibility:public"],
    deps = [
        "//bazel/ebuild/private/common/bazelutil",
        "//bazel/ebuild/private/common/fileutil",
        "//bazel/ebuild/private/common/portage/binarypackage",
        "//bazel/ebuild/private/common/standard/version",
        "@com_github_alessio_shellescape//:shellescape",
        "@com_github_urfave_cli_v2//:cli",
        "@io_bazel_rules_go//go/tools/bazel:go_default_library",
    ],
)

# If adding test data, do not depend on anything built by build_package.
# eg. //third_party/portage-stable/category/pkg:0
# If you do so, if there's a problem with the mountsdk library, the test will
# be unable to build (and therefore you can't even run the test).
go_test(
    name = "mountsdk_test",
    size = "small",
    srcs = [
        "mountsdk_test.go",
    ],
    data = [
        "testdata/mypkg.ebuild",
        "//bazel/sdk",
        "//bazel/sdk:base_sdk",
        "//overlays/overlay-arm64-generic",
        "//third_party/chromiumos-overlay",
        "//third_party/eclass-overlay",
        "//third_party/portage-stable",
    ],
    deps = [
        ":mountsdk",
        "//bazel/ebuild/private/common/standard/version",
        "@com_github_google_go_cmp//cmp:go_default_library",
        "@io_bazel_rules_go//go/tools/bazel:go_default_library",
    ],
)
