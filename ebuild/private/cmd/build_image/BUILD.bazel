# Copyright 2022 The ChromiumOS Authors.
# Use of this source code is governed by a BSD-style license that can be
# found in the LICENSE file.

load("@io_bazel_rules_go//go:def.bzl", "go_binary", "go_library")
load("//bazel/ebuild:defs.bzl", "overlay_set")
load("//bazel/ebuild/private:build_image.bzl", "build_image")

go_library(
    name = "build_image_lib",
    srcs = ["main.go"],
    data = [
        "//bazel/prebuilts/amd64-host/cross-aarch64-cros-linux-gnu:binutils",
        "//bazel/prebuilts/amd64-host/cross-aarch64-cros-linux-gnu:compiler-rt",
        "//bazel/prebuilts/amd64-host/cross-aarch64-cros-linux-gnu:gcc",
        "//bazel/prebuilts/amd64-host/cross-aarch64-cros-linux-gnu:gdb",
        "//bazel/prebuilts/amd64-host/cross-aarch64-cros-linux-gnu:glibc",
        "//bazel/prebuilts/amd64-host/cross-aarch64-cros-linux-gnu:go",
        "//bazel/prebuilts/amd64-host/cross-aarch64-cros-linux-gnu:libcxx",
        "//bazel/prebuilts/amd64-host/cross-aarch64-cros-linux-gnu:libxcrypt",
        "//bazel/prebuilts/amd64-host/cross-aarch64-cros-linux-gnu:linux-headers",
        "//bazel/prebuilts/amd64-host/cross-aarch64-cros-linux-gnu:llvm-libunwind",
        "//bazel/ebuild/private/cmd/install_deps:install_deps.sh",
    ] + glob(["container_files/*"]),
    importpath = "cros.local/bazel/ebuild/private/cmd/build_image",
    visibility = ["//visibility:private"],
    deps = [
        "//bazel/ebuild/private/common/bazelutil",
        "//bazel/ebuild/private/common/fileutil",
        "//bazel/ebuild/private/common/makechroot",
        "//bazel/ebuild/private/common/mountsdk",
        "//bazel/ebuild/private/common/processes",
        "@com_github_urfave_cli_v2//:cli",
        "@io_bazel_rules_go//go/runfiles:go_default_library",
        "@org_golang_x_sys//unix",
    ],
)

go_binary(
    name = "build_image",
    embed = [":build_image_lib"],
    visibility = ["//visibility:public"],
)

# build_image is relying on emerge to install the binpkgs this means we need
# a fully functional portage environment.
overlay_set(
    name = "overlays_build_image",
    overlays = [
        "//third_party/chromiumos-overlay:package-provided",
    ],
    visibility = ["//visibility:public"],
)

build_image(
    name = "build_image_demo",
    srcs = [
        "//:scripts_src",
        "@chromite//:src",
    ],
    build_deps = [
        # Copied from target-os:0_package_set's deps
        "//third_party/chromiumos-overlay/chromeos-base/patchpanel:0",
        "//third_party/chromiumos-overlay/sys-apps/hwids:0",
        "//third_party/chromiumos-overlay/virtual/target-os:0",
        "//third_party/chromiumos-overlay/virtual/ttf-fonts:0",
        "//third_party/portage-stable/app-misc/ca-certificates:0",
        "//third_party/portage-stable/net-dialup/ppp-scripts:0",
        "//third_party/portage-stable/sys-apps/coreutils:0",
        "//third_party/portage-stable/sys-auth/pambase:0",
        "//third_party/portage-stable/sys-devel/llvm-common:0",
    ],
    overlays = ":overlays_build_image",
    sdk = "//bazel/sdk:arm64-generic"
)
